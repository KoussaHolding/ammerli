<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fleet OS 26.2 | Redis Dispatch Console</title>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;600;700&family=SF+Mono&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
      :root {
        --ios-bg: #0a0a0c;
        --glass: rgba(25, 25, 27, 0.65);
        --glass-border: rgba(255, 255, 255, 0.1);
        --ios-accent: #0a84ff;
        --ios-radius: 28px;
        --text-sub: rgba(255, 255, 255, 0.5);
      }

      body,
      html {
        margin: 0;
        padding: 0;
        height: 100%;
        background: var(--ios-bg);
        color: #fff;
        font-family: -apple-system, 'SF Pro Display', sans-serif;
        overflow: hidden;
      }
      .app-shell {
        display: flex;
        height: 100vh;
        width: 100vw;
        padding: 16px;
        box-sizing: border-box;
        gap: 16px;
      }

      .sidebar {
        width: 380px;
        background: var(--glass);
        backdrop-filter: blur(40px) saturate(210%);
        -webkit-backdrop-filter: blur(40px) saturate(210%);
        border: 1px solid var(--glass-border);
        border-radius: var(--ios-radius);
        padding: 30px 24px;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.4);
        z-index: 100;
      }

      h1 {
        font-size: 24px;
        font-weight: 700;
        margin: 0;
        letter-spacing: -0.5px;
      }
      .subtitle {
        font-size: 11px;
        color: var(--ios-accent);
        font-weight: 700;
        text-transform: uppercase;
        margin-bottom: 25px;
        letter-spacing: 1px;
      }

      .seg-control {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        padding: 3px;
        display: flex;
        margin-bottom: 20px;
      }
      .seg-item {
        flex: 1;
        text-align: center;
        padding: 8px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        border-radius: 9px;
        transition: 0.2s;
        color: var(--text-sub);
      }
      .seg-item.active {
        background: rgba(255, 255, 255, 0.15);
        color: #fff;
      }

      .field-group {
        margin-bottom: 15px;
      }
      .field-group label {
        display: block;
        font-size: 10px;
        font-weight: 700;
        color: var(--text-sub);
        margin-left: 5px;
        margin-bottom: 5px;
        text-transform: uppercase;
      }
      input {
        width: 100%;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid transparent;
        border-radius: 12px;
        padding: 12px;
        color: white;
        font-size: 14px;
        box-sizing: border-box;
      }
      input:focus {
        outline: none;
        border-color: var(--ios-accent);
        background: rgba(255, 255, 255, 0.08);
      }

      .btn {
        width: 100%;
        padding: 14px;
        border-radius: 16px;
        font-weight: 700;
        font-size: 14px;
        cursor: pointer;
        border: none;
        transition: 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .btn-primary {
        background: var(--ios-accent);
        color: white;
      }
      .btn-glass {
        background: rgba(255, 255, 255, 0.08);
        color: white;
        border: 1px solid var(--glass-border);
      }
      .btn:active {
        transform: scale(0.97);
      }

      .feed-container {
        flex-grow: 1;
        overflow-y: auto;
        margin: 20px 0;
        padding-right: 5px;
      }
      .alert-pill {
        background: rgba(255, 255, 255, 0.04);
        padding: 16px;
        border-radius: 22px;
        margin-bottom: 12px;
        border: 1px solid var(--glass-border);
        animation: slideIn 0.4s cubic-bezier(0.1, 0.9, 0.2, 1);
      }
      .pill-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }
      .pill-id {
        font-family: 'SF Mono';
        font-size: 10px;
        color: var(--text-sub);
      }
      .pill-qty {
        background: var(--ios-accent);
        color: white;
        padding: 2px 8px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 800;
      }
      .pill-type {
        font-size: 16px;
        font-weight: 700;
        display: block;
        color: #fff;
      }
      .pill-loc {
        font-size: 11px;
        color: var(--text-sub);
        margin-top: 6px;
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .logs-box {
        background: rgba(0, 0, 0, 0.3);
        border-radius: 18px;
        padding: 12px;
        height: 100px;
        overflow-y: auto;
        font-family: 'SF Mono', monospace;
        font-size: 10px;
        border: 1px solid var(--glass-border);
      }

      .map-container {
        flex-grow: 1;
        position: relative;
        border-radius: var(--ios-radius);
        overflow: hidden;
        border: 1px solid var(--glass-border);
      }
      #map {
        height: 100%;
        width: 100%;
        background: #000;
      }
      .water-req-window {
        position: absolute;
        top: 20px;
        right: 20px;
        width: 300px;
        z-index: 1000;
        background: var(--glass);
        backdrop-filter: blur(30px);
        border-radius: var(--ios-radius);
        padding: 24px;
        border: 1px solid var(--glass-border);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
      }
      .leaflet-tile-container {
        filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%);
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateX(-20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }
    </style>
  </head>
  <body>
    <div class="app-shell">
      <aside class="sidebar">
        <h1>Gemini Fleet</h1>
        <div class="subtitle">Operational Command</div>

        <div class="seg-control">
          <div class="seg-item active" onclick="switchMode('single', this)">
            Single Unit
          </div>
          <div class="seg-item" onclick="switchMode('batch', this)">
            Batch Fleet
          </div>
        </div>

        <div id="single-mode">
          <div class="field-group">
            <label>Driver ID</label>
            <input type="text" id="sId" placeholder="TB_101" />
          </div>
          <div style="display: flex; gap: 8px">
            <div class="field-group">
              <label>Lat</label><input type="number" id="sLat" step="0.0001" />
            </div>
            <div class="field-group">
              <label>Lng</label><input type="number" id="sLng" step="0.0001" />
            </div>
          </div>
          <button class="btn btn-primary" onclick="syncSingle()">
            Connect & Sync
          </button>
          <button
            class="btn btn-glass"
            onclick="randomize('single')"
            style="margin-top: 8px"
          >
            Randomize Pos
          </button>
        </div>

        <div id="batch-mode" style="display: none">
          <button class="btn btn-glass" id="genBtn">
            Generate 10 Fleet Pins
          </button>
          <button
            class="btn btn-primary"
            id="syncBtn"
            disabled
            style="margin-top: 12px"
          >
            Sync Batch to Server
          </button>
        </div>

        <div class="feed-container">
          <label class="subtitle" style="font-size: 9px; margin-bottom: 10px"
            >Live Dispatch Feed</label
          >
          <div id="alertList"></div>
        </div>

        <div class="logs-box" id="logs">
          <div id="response" style="color: rgba(255, 255, 255, 0.4)">
            System ready...
          </div>
        </div>
      </aside>

      <main class="map-container">
        <div class="water-req-window">
          <h3 style="margin: 0 0 15px 0; font-size: 18px">Request Water</h3>
          <div style="display: flex; gap: 8px; margin-bottom: 12px">
            <div style="flex: 1">
              <label
                style="
                  font-size: 10px;
                  color: var(--ios-accent);
                  font-weight: 700;
                "
                >LAT</label
              >
              <input type="number" id="pLat" step="0.0001" />
            </div>
            <div style="flex: 1">
              <label
                style="
                  font-size: 10px;
                  color: var(--ios-accent);
                  font-weight: 700;
                "
                >LNG</label
              >
              <input type="number" id="pLng" step="0.0001" />
            </div>
          </div>
          <div class="field-group">
            <label>Note</label>
            <input type="text" id="pNote" value="Call on arrival" />
          </div>
          <button class="btn btn-primary" onclick="sendWaterRequest()">
            Post Request
          </button>
          <button
            class="btn btn-glass"
            onclick="randomize('request')"
            style="margin-top: 8px; font-size: 11px"
          >
            Randomize Pickup
          </button>
        </div>

        <div
          style="position: absolute; bottom: 20px; left: 20px; z-index: 1000"
        >
          <button
            class="btn btn-glass"
            onclick="toggleAuth(true)"
            style="padding: 10px 20px; border-radius: 12px"
          >
            Login Settings
          </button>
        </div>
        <div id="map"></div>
      </main>
    </div>

    <div
      id="authModal"
      style="
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(10px);
        z-index: 2000;
        align-items: center;
        justify-content: center;
      "
    >
      <div class="sidebar" style="width: 320px; height: auto">
        <h2>Authorization</h2>
        <input
          type="text"
          id="tokenInput"
          placeholder="Bearer Token"
          style="margin: 20px 0"
        />
        <button class="btn btn-primary" onclick="saveAuth()">Authorize</button>
        <button
          class="btn btn-glass"
          onclick="toggleAuth(false)"
          style="margin-top: 10px"
        >
          Close
        </button>
      </div>
    </div>

    <script>
      const map = L.map('map', { zoomControl: false }).setView(
        [35.412, 8.125],
        13,
      );
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(
        map,
      );

      function log(msg, color = 'rgba(255,255,255,0.6)') {
        const div = document.createElement('div');
        div.style.color = color;
        div.innerHTML = `> ${msg}`;
        const res = document.getElementById('response');
        res.prepend(div);
      }

      function getTebessaPoint() {
        return {
          lat: (35.4 + Math.random() * 0.05).toFixed(6),
          lng: (8.11 + Math.random() * 0.04).toFixed(6),
        };
      }

      function randomize(type) {
        const p = getTebessaPoint();
        if (type === 'single') {
          document.getElementById('sId').value =
            `TB_${Math.floor(Math.random() * 900) + 100}`;
          document.getElementById('sLat').value = p.lat;
          document.getElementById('sLng').value = p.lng;
        } else {
          document.getElementById('pLat').value = p.lat;
          document.getElementById('pLng').value = p.lng;
        }
      }
      randomize('single');
      randomize('request');

      function switchMode(mode, el) {
        document.getElementById('single-mode').style.display =
          mode === 'single' ? 'block' : 'none';
        document.getElementById('batch-mode').style.display =
          mode === 'batch' ? 'block' : 'none';
        document
          .querySelectorAll('.seg-item')
          .forEach((i) => i.classList.remove('active'));
        el.classList.add('active');
      }

      const trackingSocket = io('http://localhost:3200/tracking');
      let alertsSocket;

      function syncSingle() {
        const id = document.getElementById('sId').value;
        const lat = parseFloat(document.getElementById('sLat').value);
        const lng = parseFloat(document.getElementById('sLng').value);

        trackingSocket.emit('update_location', { driverId: id, lat, lng });

        if (alertsSocket) alertsSocket.disconnect();
        alertsSocket = io('http://localhost:3200/alerts', {
          query: { driverId: id },
        });

        alertsSocket.on('new_alert', (payload) => {
          // --- SAFETY PARSER START ---
          // Ensure coordinates are numbers even if backend sends strings
          const latNum = parseFloat(payload.location.lat);
          const lngNum = parseFloat(payload.location.lng);
          const qty = payload.quantity;
          const reqId = payload.requestId
            ? payload.requestId.split('-')[0]
            : 'REQ';
          // --- SAFETY PARSER END ---

          console.log(payload);
          const list = document.getElementById('alertList');
          const card = document.createElement('div');
          card.className = 'alert-pill';

          card.innerHTML = `
            <div class="pill-header">
                <span class="pill-id">#${reqId}</span>
                <span class="pill-qty">${qty} UNITS</span>
            </div>
            <span class="pill-type">${payload.type}</span>
            <div class="pill-loc">
                üìç ${latNum.toFixed(4)}, ${lngNum.toFixed(4)}
            </div>
          `;

          list.prepend(card);
          log(`Alert for ${id}: ${payload.type}`, '#0A84FF');

          L.marker([latNum, lngNum])
            .addTo(map)
            .bindPopup(`<b>${payload.type}</b><br>${qty} Units`)
            .openPopup();
        });

        log(`Driver ${id} Synced & Connected`, '#32D74B');
      }

      let fleetData = [];
      document.getElementById('genBtn').onclick = () => {
        fleetData = [];
        for (let i = 0; i < 10; i++) {
          fleetData.push({ driverId: `TB_${100 + i}`, ...getTebessaPoint() });
        }
        document.getElementById('syncBtn').disabled = false;
        log('Drafted 10 fleet units');
      };

      document.getElementById('syncBtn').onclick = async () => {
        for (let d of fleetData) {
          trackingSocket.emit('update_location', d);
          log(`Streaming: ${d.driverId}`);
          await new Promise((r) => setTimeout(r, 200));
        }
        log('Batch sync finalized', '#32D74B');
      };

      async function sendWaterRequest() {
        const token = localStorage.getItem('bearer_token');
        const payload = {
          pickupLat: parseFloat(document.getElementById('pLat').value),
          pickupLng: parseFloat(document.getElementById('pLng').value),
          quantity: 5,
          type: 'BYLITER',
          note: document.getElementById('pNote').value,
        };
        try {
          const res = await fetch('http://localhost:3200/api/requests', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(payload),
          });
          log(`API Request: ${res.status}`, res.ok ? '#32D74B' : '#FF453A');
        } catch (e) {
          log('Connection Refused', '#FF453A');
        }
      }

      function toggleAuth(show) {
        document.getElementById('authModal').style.display = show
          ? 'flex'
          : 'none';
      }
      function saveAuth() {
        localStorage.setItem(
          'bearer_token',
          document.getElementById('tokenInput').value,
        );
        toggleAuth(false);
        log('Auth Token Updated');
      }
    </script>
  </body>
</html>
